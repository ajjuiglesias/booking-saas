// Prisma Schema for Multi-Tenant Booking SaaS Platform
// Database: PostgreSQL

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Business/Tenant Model
model Business {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  email       String   @unique
  password    String
  phone       String?
  category    String   // "salon", "fitness", "consulting", "home_services", "photography"
  address     String?
  timezone    String   @default("America/New_York")
  logoUrl     String?
  primaryColor String  @default("#6366f1")
  bookingMessage String?
  
  // Booking settings
  minNoticeHours Int @default(2)
  maxAdvanceDays Int @default(30)
  bufferMinutes  Int @default(0)
  
  // Cancellation policy
  cancellationPolicy String @default("flexible") // flexible, moderate, strict
  cancellationHours  Int    @default(24)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  services    Service[]
  availability Availability[]
  bookings    Booking[]
  customers   Customer[]
  staff       Staff[]
}

// Service Model
model Service {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name        String
  description String?
  durationMinutes Int
  price       Decimal  @db.Decimal(10, 2)
  isActive    Boolean  @default(true)
  color       String?  @default("#6366f1")
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  bookings    Booking[]
  staffServices StaffService[]
  
  @@index([businessId])
}

// Availability Model
model Availability {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  staffId    String?
  staff      Staff?   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  
  dayOfWeek  Int      // 0 = Sunday, 6 = Saturday
  startTime  String   // "09:00"
  endTime    String   // "17:00"
  isAvailable Boolean @default(true)
  
  @@index([businessId])
  @@index([staffId])
}

// Blocked Date Model
model BlockedDate {
  id         String   @id @default(cuid())
  businessId String
  staffId    String?
  
  date       DateTime @db.Date
  reason     String?
  allDay     Boolean  @default(true)
  startTime  String?
  endTime    String?
  
  @@index([businessId, date])
}

// Customer Model
model Customer {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name       String
  email      String?
  phone      String
  notes      String?
  noShowCount Int     @default(0)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  bookings   Booking[]
  
  @@unique([businessId, phone])
  @@index([businessId])
}

// Booking Model
model Booking {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id])
  
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id])
  
  staffId    String?
  staff      Staff?   @relation(fields: [staffId], references: [id], onDelete: SetNull)
  
  startTime  DateTime
  endTime    DateTime
  
  status     String   @default("confirmed") // confirmed, cancelled, completed, no_show
  
  customerNotes String?
  internalNotes String?
  
  cancellationReason String?
  cancelledAt        DateTime?
  
  // Payment
  paymentStatus String @default("pending") // pending, paid, refunded
  paymentAmount Decimal? @db.Decimal(10, 2)
  paymentMethod String? // cash, card, online
  
  // Reminders sent
  reminder24hSent Boolean @default(false)
  reminder2hSent  Boolean @default(false)
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([businessId, startTime])
  @@index([customerId])
  @@index([status])
}

// Staff Model
model Staff {
  id         String   @id @default(cuid())
  businessId String
  business   Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  name       String
  email      String?
  phone      String?
  isActive   Boolean  @default(true)
  color      String?  @default("#6366f1")
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  availability Availability[]
  bookings     Booking[]
  staffServices StaffService[]
  
  @@index([businessId])
}

// Staff-Service Junction Model
model StaffService {
  id        String  @id @default(cuid())
  staffId   String
  staff     Staff   @relation(fields: [staffId], references: [id], onDelete: Cascade)
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@unique([staffId, serviceId])
}
